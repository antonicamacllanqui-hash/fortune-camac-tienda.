<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FORTUNE CAMAC S.A.C. | Tienda Oficial</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700;800&display=swap');
        
        :root {
            /* Variables de color din√°micas */
            --primary: #D91E18;    
            --gold: #FFD700;       
            --dark: #050505;       
            --surface: #121212;    
            --glass: rgba(20, 20, 25, 0.95);
            --success: #00E676;
            --edit: #2980b9; 
        }

        * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color: transparent; outline: none; font-family: 'Space Grotesk', sans-serif; }
        
        body {
            background-color: var(--dark);
            color: white;
            min-height: 100vh;
            padding-bottom: 90px;
            background-image: radial-gradient(circle at 50% 0%, rgba(255, 255, 255, 0.05), transparent 60%);
            transition: background 0.5s ease;
        }

        header {
            background: var(--glass); backdrop-filter: blur(20px);
            padding: 15px 20px; position: sticky; top: 0; z-index: 100;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .brand {
            font-weight: 800; font-size: 1.3rem; letter-spacing: -0.5px;
            background: linear-gradient(to right, #fff, var(--gold));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        
        .search-input { width: 100%; background: #1a1a1a; border: 1px solid #333; color: white; padding: 12px 20px; border-radius: 50px; }
        
        /* CATEGORIAS */
        .nav-scroll { display: flex; gap: 10px; padding: 10px 20px; overflow-x: auto; scrollbar-width: none; }
        .cat-btn { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: #aaa; padding: 8px 20px; border-radius: 30px; white-space: nowrap; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: 0.3s; }
        .cat-btn.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 4px 15px rgba(255, 255, 255, 0.1); transform: scale(1.05); }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; padding: 20px; }
        
        /* CARD */
        .card { background: var(--surface); border-radius: 18px; padding: 10px; border: 1px solid rgba(255,255,255,0.05); position: relative; transition: transform 0.2s; cursor: pointer;}
        .card:active { transform: scale(0.98); }
        .card.sold-out { opacity: 0.7; filter: grayscale(100%); }
        .badge { position: absolute; top: 8px; left: 8px; background: var(--primary); color: white; padding: 4px 8px; border-radius: 6px; font-size: 0.65rem; font-weight: bold; z-index: 5; }
        .badge-sold { background: #000; color: #fff; border: 1px solid #fff; }
        
        .card-img-box { width: 100%; height: 170px; background: #000; border-radius: 12px; overflow: hidden; margin-bottom: 10px; position: relative; }
        .card-img { width: 100%; height: 100%; object-fit: cover; }
        .multi-pic-icon { position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.6); padding: 3px 8px; border-radius: 5px; font-size: 0.7rem; backdrop-filter: blur(4px); }
        
        /* MODAL */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); z-index: 2000; display: none; justify-content: center; align-items: flex-end; }
        
        .modal-content { 
            background: #141414; width: 100%; max-width: 500px; height: 95vh; 
            border-radius: 25px 25px 0 0; display: block; overflow-y: auto; 
            border-top: 1px solid var(--primary); position: relative;
        }
        .modal-main-column { width: 100%; height: auto; display: block; }
        .modal-related-column { width: 100%; padding: 20px; background: #0f0f0f; display: block; border-top: 1px solid #333; }

        @media (min-width: 768px) {
            .modal { align-items: center; }
            .modal-content { 
                max-width: 900px; height: 85vh; border-radius: 20px; 
                display: flex; flex-direction: row; overflow: hidden; 
            }
            .modal-main-column { width: 65%; height: 100%; overflow-y: auto; border-right: 1px solid #333; }
            .modal-related-column { width: 35%; height: 100%; overflow-y: auto; border-top: none; }
        }

        .detail-body { padding: 25px; }
        
        .slider-box { height: 400px; background: #000; position: relative; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .slider-img { max-width: 100%; max-height: 100%; object-fit: contain; transition: opacity 0.3s; }
        .slider-nav { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.5); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 10; }
        .prev { left: 10px; } .next { right: 10px; }
        
        .related-card { display: flex; gap: 10px; margin-bottom: 10px; background: #1f1f1f; padding: 8px; border-radius: 10px; cursor: pointer; border: 1px solid #333; transition: 0.2s;}
        .related-card:hover { background: #333; }
        .related-img { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; }
        
        .btn-full { width: 100%; padding: 14px; background: var(--gold); border: none; border-radius: 10px; font-weight: bold; margin-top: 10px; cursor: pointer; color: black; font-size: 1rem; }
        .btn-float { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: var(--success); color: #000; padding: 15px 40px; border-radius: 50px; font-weight: 800; font-size: 1.1rem; box-shadow: 0 10px 30px rgba(0, 230, 118, 0.3); z-index: 2500; border: none; cursor: pointer; display: none; width: 90%; max-width: 400px; }
        
        /* ADMIN STYLES */
        .admin-section { display: none; }
        .upload-area { border: 2px dashed #555; padding: 20px; text-align: center; border-radius: 15px; margin-bottom: 15px; cursor: pointer; }
        .gallery-preview-grid { display: flex; gap: 5px; flex-wrap: wrap; margin-top: 10px; }
        .gallery-thumb { width: 60px; height: 60px; object-fit: cover; border-radius: 5px; border: 1px solid var(--gold); }
        
        .admin-list-item { display: flex; align-items: center; background: #1f1f1f; margin-bottom: 8px; padding: 8px; border-radius: 8px; gap: 10px; }
        .admin-list-img { width: 50px; height: 50px; object-fit: cover; border-radius: 5px; }
        .admin-list-info { flex: 1; font-size: 0.85rem; }
        .btn-action { padding: 5px 10px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; font-size: 0.75rem; display: flex; align-items: center; justify-content: center; width: 35px; height: 35px;}
        .btn-stock { background: #444; color: white; }
        .btn-stock.active { background: var(--success); color: black; }
        .btn-edit { background: var(--edit); color: white; margin-left: 5px; }
        .btn-delete { background: #ff4444; color: white; margin-left: 5px; }

        .edit-mode-bar { background: var(--edit); color: white; padding: 5px; text-align: center; border-radius: 5px; margin-bottom: 10px; font-weight: bold; display: none; }
        
        /* Estilo especial para la lista de EQUIPO */
        .team-list-container { max-height: 300px; overflow-y: auto; background: #1a1a1a; padding: 10px; border-radius: 8px; border: 1px solid #333; }
        .team-item { display: flex; justify-content: space-between; align-items: center; background: #252525; padding: 10px; border-radius: 5px; margin-bottom: 5px; }
        .team-email { font-size: 0.9rem; word-break: break-all; }

        input, textarea, select { width: 100%; padding: 12px; background: #222; border: 1px solid #333; color: white; border-radius: 8px; margin-bottom: 10px; }
    </style>
</head>
<body>

    <header>
        <div class="top-bar">
            <div class="brand">FORTUNE CAMAC</div>
            <div onclick="openAdmin()" style="cursor: pointer; opacity: 0.6; font-size: 0.9rem; border: 1px solid #444; padding: 5px 10px; border-radius: 20px;">üëë Admin</div>
        </div>
        <input type="text" id="searchInput" class="search-input" placeholder="üîç Buscar zapatillas, ropa..." onkeyup="searchProducts(this.value)">
    </header>

    <div class="nav-scroll">
        <div class="cat-btn active" onclick="filter('tendencia', this)">üî• Tendencia</div>
        <div class="cat-btn" onclick="filter('combos', this)">üéÅ Combos</div>
        <div class="cat-btn" onclick="filter('zapatillas', this)">üëü Zapatillas</div>
        <div class="cat-btn" onclick="filter('juguetes', this)">üéÆ Juguetes</div>
        <div class="cat-btn" onclick="filter('tecnologia', this)">üì± Tecnolog√≠a</div>
        <div class="cat-btn" onclick="filter('hogar', this)">üè† Hogar</div>
    </div>

    <div class="grid" id="grid"></div>

    <button id="cartBtn" class="btn-float" onclick="openCheckout()">
        <i class="fa-solid fa-cart-shopping"></i> &nbsp; Ir a Pagar (S/ <span id="cartTotal">0.00</span>)
    </button>

    <div id="detailModal" class="modal">
        <div class="modal-content">
            <button onclick="closeModal('detailModal')" style="position: absolute; top: 15px; right: 15px; z-index: 20; background: rgba(0,0,0,0.5); color: white; border: none; width: 35px; height: 35px; border-radius: 50%; font-size: 1.2rem;">‚úï</button>
            <div class="modal-main-column">
                <div class="slider-box" id="sliderBox">
                    <button class="slider-nav prev" onclick="moveSlide(-1)">‚ùÆ</button>
                    <img id="dImg" class="slider-img">
                    <button class="slider-nav next" onclick="moveSlide(1)">‚ùØ</button>
                </div>
                <div class="detail-body">
                    <div style="color: var(--gold);">‚òÖ ‚òÖ ‚òÖ ‚òÖ ‚òÖ</div>
                    <h2 id="dName" style="font-size: 1.8rem; line-height: 1.1; margin: 5px 0;"></h2>
                    <h3 id="dPrice" style="color: var(--success); font-size: 2rem; font-weight: 800; margin: 10px 0;"></h3>
                    <p id="dDesc" style="color: #ccc; line-height: 1.5;"></p>
                    <button id="addToCartBtn" onclick="addToCartCurrent()" class="btn-full" style="background: var(--primary); color: white; margin-top: 20px;">A√ëADIR AL CARRITO</button>
                    <div style="margin-top: 30px; border-top: 1px solid #333; padding-top: 20px;">
                        <h3>üí¨ Opiniones</h3>
                        <div id="reviewsList" style="margin-bottom: 15px;"></div>
                        <div style="background: #222; padding: 15px; border-radius: 10px;">
                            <input type="text" id="rName" placeholder="Tu nombre">
                            <textarea id="rComment" placeholder="Tu opini√≥n..." rows="2"></textarea>
                            <button onclick="submitReview()" class="btn-full" style="font-size: 0.8rem; background: #444; color: white;">ENVIAR RESE√ëA</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-related-column">
                <h4 style="color: var(--gold); margin-bottom: 15px;">Te puede interesar:</h4>
                <div id="relatedList"></div>
            </div>
        </div>
    </div>

    <div id="cartModal" class="modal">
        <div class="modal-content" style="height: auto; max-width: 500px; padding: 20px; display:block;">
            <h2 style="color: var(--gold);">üõí Tu Pedido</h2>
            <div id="cartItems" style="max-height: 250px; overflow-y: auto; margin: 15px 0;"></div>
            <div style="text-align: right; font-weight: bold; font-size: 1.2rem; margin-bottom: 10px;">Total: S/ <span id="modalTotal">0.00</span></div>
            <input type="text" id="cName" placeholder="Tu Nombre Completo">
            <input type="text" id="cAddr" placeholder="Direcci√≥n / Distrito">
            <p style="font-size:0.8rem; color:#aaa; margin-bottom:5px;">M√©todo de Pago:</p>
            <select id="cPay"></select>
            <button onclick="sendWhatsapp()" class="btn-full" style="background: var(--success);">PEDIR POR WHATSAPP</button>
            <button onclick="closeModal('cartModal')" class="btn-full" style="background: transparent; border: 1px solid #444; color: #888;">Seguir comprando</button>
        </div>
    </div>

    <div id="adminModal" class="modal" style="z-index: 3000;">
        <div class="modal-content" style="padding: 20px; background: #111; max-width:600px; display:block; overflow-y: auto;">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <h3>Panel Admin</h3>
                <div>
                    <button onclick="logoutAdmin()" style="background:#cc0000; color:white; border:none; padding:8px 12px; border-radius:5px; font-weight:bold; cursor:pointer;">CERRAR SESI√ìN</button>
                    <button onclick="closeModal('adminModal')" style="background:none; border:none; color:white; font-size:1.5rem; margin-left:10px;">‚úï</button>
                </div>
            </div>

            <div id="loginForm">
                <input type="email" id="adminEmail" placeholder="admin@tienda.com">
                <input type="password" id="adminPass" placeholder="Contrase√±a">
                <button onclick="authAdmin()" class="btn-full">INGRESAR</button>
            </div>

            <div id="adminPanel" style="display: none;">
                <div style="display: flex; gap: 10px; margin-bottom: 15px; overflow-x: auto;">
                    <button onclick="tab('prod')" class="cat-btn active">Productos</button>
                    <button onclick="tab('pagos')" class="cat-btn">Pagos</button>
                    <button onclick="tab('conf')" class="cat-btn">Temas</button>
                    <button onclick="tab('rev')" class="cat-btn">Rese√±as</button>
                    <button onclick="tab('team')" class="cat-btn">Equipo</button>
                </div>

                <div id="tab-prod" class="admin-section" style="display: block;">
                    
                    <div id="prodFormContainer" style="border:1px solid #333; padding:15px; border-radius:10px; margin-bottom:20px; background:#1a1a1a;">
                        <div id="editModeBar" class="edit-mode-bar">‚úèÔ∏è MODO EDICI√ìN ACTIVO</div>
                        <h4 style="color:var(--gold); margin-bottom:10px;" id="formTitle">Subir Nuevo Producto</h4>
                        
                        <div class="upload-area" onclick="document.getElementById('fileIn').click()">
                            <p>üì∏ Toca para subir/cambiar foto</p>
                        </div>
                        <input type="file" id="fileIn" hidden accept="image/*" onchange="processFile(this.files[0])">
                        <div id="previewGrid" class="gallery-preview-grid"></div>

                        <input type="text" id="pName" placeholder="Nombre (Ej: Zapatilla Nike)">
                        <div style="display:flex; gap:10px;">
                            <input type="number" id="pPrice" placeholder="Precio (S/)">
                            <select id="pCat">
                                <option value="tendencia">Tendencia</option>
                                <option value="zapatillas">Zapatillas</option>
                                <option value="juguetes">Juguetes</option>
                                <option value="combos">Combos</option>
                                <option value="tecnologia">Tecnolog√≠a</option>
                                <option value="hogar">Hogar</option>
                            </select>
                        </div>
                        <textarea id="pDesc" placeholder="Descripci√≥n..."></textarea>
                        
                        <div style="margin-bottom: 10px; display: flex; gap: 15px;">
                            <span><input type="checkbox" id="pIsOffer"> Oferta</span>
                            <span><input type="checkbox" id="pIsSoldOut"> Agotado</span>
                        </div>
                        
                        <button id="saveBtn" onclick="saveProduct()" class="btn-full">PUBLICAR</button>
                        <button id="cancelEditBtn" onclick="cancelEdit()" class="btn-full" style="background:#555; display:none; margin-top:5px;">CANCELAR EDICI√ìN</button>
                    </div>

                    <h4 style="color:var(--gold); border-bottom:1px solid #333; padding-bottom:5px;">Inventario Actual</h4>
                    <div id="adminProductList"></div>
                </div>

                <div id="tab-pagos" class="admin-section">
                    <h4>M√©todos de Pago</h4>
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="newPayMethod" placeholder="Ej: Yape 999...">
                        <button onclick="addPayment()" style="background:var(--success); border:none; border-radius:5px; width:50px;">+</button>
                    </div>
                    <div id="adminPaymentsList" style="margin-top: 10px;"></div>
                </div>

                <div id="tab-conf" class="admin-section">
                    <h3>üé® Temas Festivos</h3>
                    <select id="shopThemeSelect" style="margin-top: 10px;">
                        <option value="default">Original (Rojo/Dorado)</option>
                        <option value="verano">Modo Verano (Azul/Naranja)</option>
                        <option value="sanvalentin">üíò San Valent√≠n (Rosa/Rojo)</option>
                        <option value="navidad">üéÑ Navidad (Rojo/Verde)</option>
                        <option value="anonuevo">üéâ A√±o Nuevo (Dorado/Plata)</option>
                        <option value="halloween">üéÉ Halloween (Naranja/Morado)</option>
                    </select>
                    <button onclick="saveTheme()" class="btn-full">APLICAR TEMA</button>
                </div>

                <div id="tab-rev" class="admin-section">
                    <h4>Pendientes de Aprobaci√≥n</h4>
                    <div id="pendingReviews"></div>
                </div>

                <div id="tab-team" class="admin-section">
                    <h3>üë• Gesti√≥n de Equipo</h3>
                    <p style="color:#aaa; font-size:0.8rem; margin-bottom:10px;">Agrega correos de socios o ayudantes:</p>
                    <div style="display:flex; gap:10px; margin-bottom:15px;">
                        <input type="email" id="newAdminEmail" placeholder="nuevo_socio@gmail.com" style="margin-bottom:0;">
                        <button onclick="addAdmin()" style="background:var(--gold); color:black; border:none; border-radius:5px; width:80px; font-weight:bold;">AGREGAR</button>
                    </div>
                    <div id="adminListContainer" class="team-list-container">
                        </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, deleteDoc, updateDoc, where, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyCNozgDrFr2h8JEaUEjzAbCWbNor_kL-ik",
            authDomain: "fotune-camac.firebaseapp.com",
            projectId: "fotune-camac",
            storageBucket: "fotune-camac.firebasestorage.app",
            messagingSenderId: "787023622151",
            appId: "1:787023622151:web:afe9343d034f934458baa2"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        const productsRef = collection(db, "productos");
        const reviewsRef = collection(db, "resenas");
        const paymentsRef = doc(db, "config", "pagos");
        const themeRef = doc(db, "config", "temas");
        const adminsRef = doc(db, "config", "adminList");
        const WHATSAPP_NUMBER = "51951001546";

        let products = [], cart = [], currentProduct = null, tempGallery = [];
        let slideIndex = 0;
        let paymentMethods = ["Yape / Plin", "Efectivo Contraentrega"]; 
        let allowedAdmins = [];
        let editingProductId = null; 

        // --- 1. CARGAR DATOS ---
        onSnapshot(query(productsRef, orderBy("timestamp", "desc")), (snap) => {
            products = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            renderGrid();
            renderAdminInventory();
        });

        onSnapshot(themeRef, (snap) => {
            if(snap.exists()) applyTheme(snap.data().current);
        });

        function applyTheme(themeName) {
            const root = document.documentElement;
            if (themeName === 'verano') { root.style.setProperty('--primary', '#007BFF'); root.style.setProperty('--gold', '#FFA500'); }
            else if (themeName === 'sanvalentin') { root.style.setProperty('--primary', '#E91E63'); root.style.setProperty('--gold', '#FFC107'); }
            else if (themeName === 'navidad') { root.style.setProperty('--primary', '#C0392B'); root.style.setProperty('--gold', '#2ECC71'); }
            else if (themeName === 'anonuevo') { root.style.setProperty('--primary', '#DAA520'); root.style.setProperty('--gold', '#BDC3C7'); }
            else if (themeName === 'halloween') { root.style.setProperty('--primary', '#E67E22'); root.style.setProperty('--gold', '#8E44AD'); }
            else { root.style.setProperty('--primary', '#D91E18'); root.style.setProperty('--gold', '#FFD700'); }
        }

        // --- 2. GRID Y DETALLES ---
        window.renderGrid = (cat = 'tendencia') => {
            const list = cat === 'tendencia' ? products : products.filter(p => p.cat === cat);
            const grid = document.getElementById('grid');
            if(!list.length) { grid.innerHTML = '<p style="color:#aaa; text-align:center;">No hay productos.</p>'; return; }

            grid.innerHTML = list.map(p => {
                const multi = (p.gallery && p.gallery.length > 1) ? '<div class="multi-pic-icon">üì∑ Varios</div>' : '';
                const soldClass = p.isSoldOut ? 'sold-out' : '';
                const soldBadge = p.isSoldOut ? '<div class="badge badge-sold">AGOTADO</div>' : (p.isOffer ? '<div class="badge">OFERTA</div>' : '');
                
                return `
                <div class="card ${soldClass}" onclick="openDetail('${p.id}')">
                    ${soldBadge}
                    <div class="card-img-box"><img src="${p.img}" class="card-img" loading="lazy">${multi}</div>
                    <div class="rating-stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
                    <div style="font-size:0.9rem; font-weight:bold;">${p.name}</div>
                    <div style="color:var(--gold);">S/ ${p.price}</div>
                </div>
            `}).join('');
        };

        window.openDetail = (id) => {
            const p = products.find(x => x.id === id);
            if(!p) return;
            currentProduct = p;
            slideIndex = 0;
            
            document.getElementById('dName').innerText = p.name;
            document.getElementById('dPrice').innerText = "S/ " + p.price;
            document.getElementById('dDesc').innerText = p.desc || "";
            
            const btn = document.getElementById('addToCartBtn');
            if (p.isSoldOut) {
                btn.innerHTML = "üö´ PRODUCTO AGOTADO";
                btn.style.background = "#333";
                btn.style.color = "#888";
                btn.style.cursor = "not-allowed";
                btn.onclick = null;
            } else {
                btn.innerHTML = "A√ëADIR AL CARRITO";
                btn.style.background = "var(--primary)";
                btn.style.color = "white";
                btn.style.cursor = "pointer";
                btn.onclick = window.addToCartCurrent;
            }

            updateSlider();
            loadReviews(id);
            renderRelated(p.cat, p.id);
            document.getElementById('detailModal').style.display = 'flex';
        };

        function renderRelated(category, currentId) {
            const list = document.getElementById('relatedList');
            const related = products.filter(x => x.cat === category && x.id !== currentId && !x.isSoldOut).slice(0, 4);
            if (related.length === 0) { list.innerHTML = "<p style='color:#666; font-size:0.8rem;'>No hay similares disponibles.</p>"; return; }
            list.innerHTML = related.map(r => `
                <div class="related-card" onclick="openDetail('${r.id}')">
                    <img src="${r.img}" class="related-img">
                    <div>
                        <div style="font-weight:bold; font-size:0.9rem;">${r.name}</div>
                        <div style="color:var(--gold);">S/ ${r.price}</div>
                    </div>
                </div>
            `).join('');
        }

        window.closeModal = (id) => document.getElementById(id).style.display = 'none';

        // --- 3. SLIDER ---
        window.updateSlider = () => {
            const gallery = (currentProduct.gallery && currentProduct.gallery.length > 0) ? currentProduct.gallery : [currentProduct.img];
            document.getElementById('dImg').src = gallery[slideIndex];
        };
        window.moveSlide = (n) => {
            const gallery = (currentProduct.gallery && currentProduct.gallery.length > 0) ? currentProduct.gallery : [currentProduct.img];
            slideIndex += n;
            if(slideIndex >= gallery.length) slideIndex = 0;
            if(slideIndex < 0) slideIndex = gallery.length - 1;
            updateSlider();
        };

        // --- 4. CARRITO ---
        window.addToCartCurrent = () => {
            if(!currentProduct) return;
            cart.push(currentProduct);
            updateCartUI();
            closeModal('detailModal');
            alert("¬°Agregado al carrito!");
        };

        function updateCartUI() {
            const total = cart.reduce((acc, item) => acc + parseFloat(item.price), 0);
            document.getElementById('cartTotal').innerText = total.toFixed(2);
            document.getElementById('cartBtn').style.display = cart.length > 0 ? 'block' : 'none';
        }

        window.openCheckout = () => {
            document.getElementById('cartItems').innerHTML = cart.map((item, i) => `
                <div style="display:flex; justify-content:space-between; margin-bottom:10px; border-bottom:1px solid #333; padding-bottom:5px;">
                    <div>${item.name} <br> <small>S/ ${item.price}</small></div>
                    <button onclick="removeFromCart(${i})" style="color:red; background:none; border:none;">‚úï</button>
                </div>
            `).join('');
            document.getElementById('modalTotal').innerText = document.getElementById('cartTotal').innerText;
            document.getElementById('cartModal').style.display = 'block'; 
        };

        window.removeFromCart = (i) => { cart.splice(i, 1); updateCartUI(); openCheckout(); };

        window.sendWhatsapp = () => {
            const n = document.getElementById('cName').value || "Cliente";
            const a = document.getElementById('cAddr').value || "Consultar env√≠o";
            let p = document.getElementById('cPay').value;
            if(!p) p = "Acordar pago";
            let msg = `üõçÔ∏è *PEDIDO WEB*\nüë§ *Cliente:* ${n}\nüìç *Direcci√≥n:* ${a}\nüí≥ *Pago:* ${p}\n\nüì¶ *PRODUCTOS:*\n`;
            cart.forEach(c => msg += `- ${c.name} (S/ ${c.price})\n`);
            const total = document.getElementById('modalTotal').innerText;
            msg += `\nüí∞ *TOTAL A PAGAR: S/ ${total}*`;
            window.open(`https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(msg)}`);
        };

        // --- 5. PAGOS ---
        onSnapshot(paymentsRef, (snap) => {
            if(snap.exists() && snap.data().list) { paymentMethods = snap.data().list; }
            renderPaymentsUI();
        });
        function renderPaymentsUI() {
            const select = document.getElementById('cPay');
            select.innerHTML = paymentMethods.map(m => `<option value="${m}">${m}</option>`).join('');
            const list = document.getElementById('adminPaymentsList');
            if(list) {
                list.innerHTML = paymentMethods.map((m, i) => 
                    `<div style="background:#333; padding:5px; margin-bottom:5px; display:flex; justify-content:space-between;">
                        ${m} <button onclick="window.remPay(${i})" style="color:red; background:none; border:none;">üóëÔ∏è</button>
                    </div>`
                ).join('');
            }
        }
        window.addPayment = async () => {
            const val = document.getElementById('newPayMethod').value;
            if(!val) return;
            const newList = [...paymentMethods, val];
            await setDoc(paymentsRef, { list: newList });
            document.getElementById('newPayMethod').value = "";
        };
        window.remPay = async (i) => {
            const newList = paymentMethods.filter((_, idx) => idx !== i);
            await setDoc(paymentsRef, { list: newList });
        };

        // --- 6. ADMIN: INVENTARIO, STOCK Y EDICI√ìN ---
        function renderAdminInventory() {
            const div = document.getElementById('adminProductList');
            if(!div) return;
            div.innerHTML = products.map(p => `
                <div class="admin-list-item">
                    <img src="${p.img}" class="admin-list-img">
                    <div class="admin-list-info">
                        <div><b>${p.name}</b></div>
                        <div>S/ ${p.price} | ${p.cat}</div>
                    </div>
                    <button class="btn-action btn-stock ${!p.isSoldOut ? 'active' : ''}" onclick="toggleStock('${p.id}', ${!p.isSoldOut})">
                        ${p.isSoldOut ? 'üì¶' : 'üü¢'}
                    </button>
                    <button class="btn-action btn-edit" onclick="startEdit('${p.id}')">‚úèÔ∏è</button>
                    <button class="btn-action btn-delete" onclick="deleteProd('${p.id}')">üóëÔ∏è</button>
                </div>
            `).join('');
        }

        window.toggleStock = async (id, status) => {
            await updateDoc(doc(db, "productos", id), { isSoldOut: status });
        };

        window.deleteProd = async (id) => {
            if(confirm("¬øBorrar permanentemente?")) await deleteDoc(doc(db, "productos", id));
        };

        // --- LOGICA DE EDICION ---
        window.startEdit = (id) => {
            const p = products.find(x => x.id === id);
            if(!p) return;
            
            document.getElementById('pName').value = p.name;
            document.getElementById('pPrice').value = p.price;
            document.getElementById('pCat').value = p.cat;
            document.getElementById('pDesc').value = p.desc;
            document.getElementById('pIsOffer').checked = p.isOffer;
            document.getElementById('pIsSoldOut').checked = p.isSoldOut || false;

            tempGallery = p.gallery || [p.img];
            document.getElementById('previewGrid').innerHTML = tempGallery.map((s,i) => `<img src="${s}" class="gallery-thumb" onclick="remImg(${i})">`).join('');

            editingProductId = id;
            document.getElementById('saveBtn').innerText = "ACTUALIZAR PRODUCTO";
            document.getElementById('saveBtn').style.background = "var(--edit)";
            document.getElementById('formTitle').innerText = "Editando: " + p.name;
            document.getElementById('editModeBar').style.display = "block";
            document.getElementById('cancelEditBtn').style.display = "block";
            
            document.getElementById('prodFormContainer').scrollIntoView({behavior: 'smooth'});
        };

        window.cancelEdit = () => {
            editingProductId = null;
            document.getElementById('pName').value = "";
            document.getElementById('pPrice').value = "";
            document.getElementById('pDesc').value = "";
            document.getElementById('previewGrid').innerHTML = "";
            tempGallery = [];
            
            document.getElementById('saveBtn').innerText = "PUBLICAR";
            document.getElementById('saveBtn').style.background = "var(--gold)";
            document.getElementById('formTitle').innerText = "Subir Nuevo Producto";
            document.getElementById('editModeBar').style.display = "none";
            document.getElementById('cancelEditBtn').style.display = "none";
        };

        window.saveProduct = async () => {
            const name = document.getElementById('pName').value;
            const price = document.getElementById('pPrice').value;
            const cat = document.getElementById('pCat').value;
            const desc = document.getElementById('pDesc').value;
            const isOffer = document.getElementById('pIsOffer').checked;
            const isSoldOut = document.getElementById('pIsSoldOut').checked;

            if(!name || !price) return alert("Falta nombre o precio");
            if(!editingProductId && tempGallery.length === 0) return alert("Sube al menos una foto");

            const productData = {
                name, price, cat, desc, isOffer, isSoldOut,
                timestamp: Date.now()
            };

            if(tempGallery.length > 0) {
                productData.img = tempGallery[0];
                productData.gallery = tempGallery;
            }

            if(editingProductId) {
                await updateDoc(doc(db, "productos", editingProductId), productData);
                alert("¬°Producto Actualizado!");
                cancelEdit();
            } else {
                await addDoc(productsRef, productData);
                alert("¬°Producto Publicado!");
                cancelEdit();
            }
        };

        // --- 7. EQUIPO (ADMINS) MEJORADO ---
        function loadAdmins() {
            onSnapshot(adminsRef, (docSnap) => {
                if (docSnap.exists()) {
                    allowedAdmins = docSnap.data().emails || [];
                    document.getElementById('adminListContainer').innerHTML = allowedAdmins.map(e => 
                        `<div class="team-item">
                            <span class="team-email">${e}</span>
                            <button onclick="window.remAdmin('${e}')" class="btn-action btn-delete" style="width:auto; padding:5px 10px;">ELIMINAR</button>
                        </div>`).join('');
                }
            });
        }
        window.addAdmin = async () => {
            const em = document.getElementById('newAdminEmail').value.trim();
            if(!em) return alert("Escribe un correo v√°lido");
            if(allowedAdmins.includes(em)) return alert("Ya existe ese correo");
            
            const newList = [...allowedAdmins, em];
            await setDoc(adminsRef, { emails: newList }, { merge: true });
            document.getElementById('newAdminEmail').value = "";
            alert("¬°Socio agregado!");
        };
        window.remAdmin = async (email) => {
            if(!confirm("¬øEliminar acceso a " + email + "?")) return;
            const newList = allowedAdmins.filter(e => e !== email);
            await setDoc(adminsRef, { emails: newList }, { merge: true });
        };

        // --- GENERAL ---
        window.openAdmin = () => document.getElementById('adminModal').style.display = 'flex';
        
        window.authAdmin = async () => {
            const e = document.getElementById('adminEmail').value;
            const p = document.getElementById('adminPass').value;
            try { await signInWithEmailAndPassword(auth, e, p); } catch(err) { alert("Error: "+err.message); }
        };

        window.logoutAdmin = async () => {
            await signOut(auth);
            alert("Sesi√≥n Cerrada");
        };

        window.saveTheme = async () => {
            const t = document.getElementById('shopThemeSelect').value;
            await setDoc(themeRef, { current: t });
            alert("Tema actualizado.");
        };

        window.processFile = (file) => {
            const reader = new FileReader();
            reader.onload = e => {
                tempGallery.push(e.target.result);
                document.getElementById('previewGrid').innerHTML = tempGallery.map((s,i) => `<img src="${s}" class="gallery-thumb" onclick="remImg(${i})">`).join('');
            };
            reader.readAsDataURL(file);
        };
        window.remImg = (i) => { tempGallery.splice(i,1); };

        onAuthStateChanged(auth, (user) => {
            if(user) {
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'block';
                loadPendingReviews();
                renderPaymentsUI();
                loadAdmins();
                renderAdminInventory();
            } else {
                document.getElementById('loginForm').style.display = 'block';
                document.getElementById('adminPanel').style.display = 'none';
            }
        });

        window.tab = (t) => {
            document.querySelectorAll('.admin-section').forEach(s => s.style.display = 'none');
            document.getElementById('tab-'+t).style.display = 'block';
        };
        window.filter = (c, el) => {
            document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
            el.classList.add('active');
            renderGrid(c);
        };
        window.searchProducts = (q) => {
            if(!q) return renderGrid();
            const list = products.filter(p => p.name.toLowerCase().includes(q.toLowerCase()));
            const grid = document.getElementById('grid');
            grid.innerHTML = list.map(p => `<div class="card" onclick="openDetail('${p.id}')"><div class="card-img-box"><img src="${p.img}" class="card-img"></div><div>${p.name}</div></div>`).join('');
        };

        // Rese√±as
        window.submitReview = async () => {
            const n = document.getElementById('rName').value;
            const t = document.getElementById('rComment').value;
            if(n && t) { await addDoc(reviewsRef, { pid: currentProduct.id, user: n, text: t, status: 'pending' }); alert("Enviado"); }
        };
        function loadPendingReviews() {
            onSnapshot(query(reviewsRef, where("status", "==", "pending")), (snap) => {
                document.getElementById('pendingReviews').innerHTML = snap.docs.map(d => `
                    <div style="background:#333; padding:10px; margin-bottom:5px;">${d.data().text} 
                    <button onclick="revAct('${d.id}', 'ok')">‚úÖ</button> <button onclick="revAct('${d.id}', 'no')">‚ùå</button></div>`).join('');
            });
        }
        function loadReviews(pid) {
            onSnapshot(query(reviewsRef, where("pid", "==", pid), where("status", "==", "approved")), (snap) => {
                const list = document.getElementById('reviewsList');
                if(snap.empty) list.innerHTML = "<small>Opina primero</small>";
                else list.innerHTML = snap.docs.map(d => `<div style="background:#222; padding:8px; border-radius:5px; margin-bottom:5px;"><b>${d.data().user}</b>: ${d.data().text}</div>`).join('');
            });
        }
        window.revAct = async (id, act) => {
            if(act === 'no') await deleteDoc(doc(db, "resenas", id));
            else await updateDoc(doc(db, "resenas", id), { status: 'approved' });
        };
    </script>
</body>
</html>